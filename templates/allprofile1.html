{% extends 'base.html' %}
{% load static %}
{% block title %}
level 1
{% endblock%}
{% block content %}
    <!-- Page Banner -->
    <div class="page-banner2">
        <h1>Find Skilled Workers Near You</h1>
        <p>Browse a variety of professionals available for temporary, contract, and seasonal work.</p>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Search Bar -->
        <div class="search-bar">
            <div class="input-group mb-4">
                <input type="text" class="form-control" placeholder="Search profiles...">
                <button class="btn btn-primary">Search</button>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Filters (Col 3) -->
            <div class="col-md-2">
                <div class="filters-section">
                    <h4>Filters</h4>
                    <input type="text" class="form-control mb-3" placeholder="Location">
                    <input type="text" class="form-control mb-3" placeholder="Skill">
                    <select class="form-select mb-3">
                        <option value="">All Categories</option>
                        <option value="Home Services">Home Services</option>
                        <option value="Events">Events</option>
                        <option value="Food & Beverage">Food & Beverage</option>
                    </select>
                    <button class="btn btn-primary w-100">Reset Filters</button>
                </div>
                
            </div>

            <!-- Profile Cards (Col 9) -->
<div class="col-md-8">
                <div class="row">
                    {% for profile in profiles1%}
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="profile-card-1">

{% if request.user == profile.user %}
<!-- Edit Button (opens modal) -->
<div class="position-absolute top-0 m-2">
  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal{{ profile.id }}">
    <i class="bi bi-pencil"></i> Edit
  </button>
</div>
{% endif %}
                            <!-- Add the availability status indicator RIGHT HERE - at the beginning of the card -->
<div class="availability-status">
    {% if request.user == profile.user %}
    <form method="POST" action="{% url 'update_availability' profile.id %}" class="availability-form">
        {% csrf_token %}
        <label><input type="radio" name="availability_status" value="available" {% if profile.availability_status == 'available' %}checked{% endif %} onchange="this.form.submit()"> Available</label>
        <label><input type="radio" name="availability_status" value="booked_today" {% if profile.availability_status == 'booked_today' %}checked{% endif %} onchange="this.form.submit()"> Booked Today</label>
        <label><input type="radio" name="availability_status" value="unavailable" {% if profile.availability_status == 'unavailable' %}checked{% endif %} onchange="this.form.submit()"> Unavailable</label>
    </form>
    {% endif %}

    {% if profile.availability_status == 'available' %}
        <span class="badge bg-success"><i class="fas fa-check-circle"></i> Available</span>
    {% elif profile.availability_status == 'booked_today' %}
        <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Booked Today</span>
        {% if profile.next_available_date %}
            <span class="badge bg-info">Next: {{ profile.next_available_date|date:"M d" }}</span>
        {% endif %}
    {% else %}
        <span class="badge bg-secondary"><i class="fas fa-times-circle"></i> Unavailable</span>
        {% if profile.next_available_date %}
            <span class="badge bg-info">Next: {{ profile.next_available_date|date:"M d" }}</span>
        {% endif %}
    {% endif %}
</div>

                            <!-- Add the availability status indicator RIGHT HERE - at the beginning of the card -->
                            <div class="availability-status">
                                {% if profile.availability_status == 'available' %}
                                    <span class="badge bg-success"><i class="fas fa-check-circle"></i> Available</span>
                                {% elif profile.availability_status == 'booked_today' %}
                                    <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> Booked Today</span>
                                    {% if profile.next_available_date %}
                                        <span class="badge bg-info">Next: {{ profile.next_available_date|date:"M d" }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary"><i class="fas fa-times-circle"></i> Unavailable</span>
                                    {% if profile.next_available_date %}
                                        <span class="badge bg-info">Next: {{ profile.next_available_date|date:"M d" }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                            
                            
                            <!-- Profile Image -->
                            {% if profile.profile_picture %}
                            <img src="{{ profile.profile_picture.url }}" alt="Profile Image" class="profile-image">
                            {% else %}
                            <img src="{% static 'images/default-profile.jpg' %}" alt="Profile Image" class="profile-image">
                            {% endif %}
                        <!-- Profile Name -->
                        <div class="profile-name-1">{{ profile.user.username }}</div>
    
                        <!-- Profile Info -->
                        <div class="profile-info-1"><i class="fas fa-phone"></i> +250 {{profile.phone}}</div>
                        <div class="profile-info-1">
                            <i class="fas fa-map-marker-alt"></i>
                            {% if profile.address %}
                              {{ profile.address.cell }}, {{ profile.address.province }}
                            {% else %}
                              <span class="text-muted">No address provided</span>
                            {% endif %}
                          </div>
                          
    
                        <!-- Profile Skills -->
                        <div class="skills-container-1">
                            <div class="skills-label-1">Skills</div>
                            <div class="skills-list-1">
                                <span class="skill-tag-1">Plumbing</span>
                                <span class="skill-tag-1">Welding & Metal Fabrication</span>
                                <span class="skill-tag-1">Roofing</span>
                                <span class="skill-tag-1">Glass Installation</span>
                                <span class="skill-tag-1">Interior Design</span>
                                <span class="skill-tag-1">Electrical Wiring</span>
                                <span class="skill-tag-1">Carpentry</span>
                                <span class="skill-tag-1">Landscaping</span>
                            </div>
                        </div>
    
                        <!-- Like Section -->
                        <div class="like-section-1">
                            <i class="fas fa-thumbs-up {% if request.user in profile.likes.all %}liked{% endif %}" 
                               id="like-button-{{ profile.id }}"></i>
                            <span id="like-count-{{ profile.id }}">{{ profile.total_likes }} Like{{ profile.total_likes|pluralize }}</span>
                        </div>
                        
    
                        <!-- Social Media Links -->
                        <div class="social-icons-1">
                            <a href="#" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
                            <a href="#" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>


                    {% if request.user == profile.user %}
<div class="modal fade" id="editProfileModal{{ profile.id }}" tabindex="-1" aria-labelledby="editProfileModalLabel{{ profile.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <form method="POST" action="{% url 'update_profile' profile.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="editProfileModalLabel{{ profile.id }}">Edit Your Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <!-- Phone -->
          <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="text" name="phone" class="form-control" value="{{ profile.phone }}">
          </div>

          <!-- Profile Picture -->
          <div class="mb-3">
            <label class="form-label">Profile Picture</label>
            <input type="file" name="profile_picture" class="form-control">
            {% if profile.profile_picture %}
              <img src="{{ profile.profile_picture.url }}" class="mt-2 rounded" style="max-height: 100px;">
            {% endif %}
          </div>

          <!-- Address (Simplified for now; ideally, use dynamic select widgets) -->
          <div class="mb-3">
            <label class="form-label">Address (ID)</label>
            <input type="text" name="address_id" class="form-control" value="{{ profile.address.id }}">
            <small class="text-muted">Use actual address ID or implement select field</small>
          </div>

          <!-- Availability -->
          <div class="mb-3">
            <label class="form-label">Availability Status</label>
            <select name="availability_status" class="form-select">
              {% for value, label in profile.AVAILABILITY_CHOICES %}
                <option value="{{ value }}" {% if profile.availability_status == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Next Available Date -->
          <div class="mb-3">
            <label class="form-label">Next Available Date</label>
            <input type="date" name="next_available_date" class="form-control" value="{{ profile.next_available_date|date:'Y-m-d' }}">
          </div>

          <!-- Skills (Multi-Select) -->
          <div class="mb-3">
            <label class="form-label">Skills</label>
            <select name="skills" class="form-select" multiple>
              {% for skill in all_skills %}
                <option value="{{ skill.id }}" {% if skill in profile.skills.all %}selected{% endif %}>{{ skill.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

                </div>
                {% endfor %}
                </div>
                
                <div class="pagination justify-content-center mt-4">
                    <nav aria-label="Page navigation">
                      <ul class="pagination">
                        {% if profiles1.has_previous %}
                          <li class="page-item">
                            <a class="page-link" href="?page={{ profiles1.previous_page_number }}" aria-label="Previous">
                              <span aria-hidden="true">&laquo;</span>
                            </a>
                          </li>
                        {% else %}
                          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                        {% endif %}
                  
                        {% for num in profiles1.paginator.page_range %}
                          {% if profiles1.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                          {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                          {% endif %}
                        {% endfor %}
                  
                        {% if profiles1.has_next %}
                          <li class="page-item">
                            <a class="page-link" href="?page={{ profiles1.next_page_number }}" aria-label="Next">
                              <span aria-hidden="true">&raquo;</span>
                            </a>
                          </li>
                        {% else %}
                          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                        {% endif %}
                      </ul>
                    </nav>
                  </div>     
                               
            </div>

        </div>
      
    </div>

<style>
    .fa-thumbs-up {
        color: #666;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .fa-thumbs-up.liked {
        color: #4267B2;
    }
    
    .fa-thumbs-up:hover {
        color: #4267B2;
    }



    /* Add these new styles to your existing style section */
    .availability-status {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1;
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .availability-status .badge {
        font-size: 0.75rem;
        padding: 4px 6px;
        white-space: nowrap;
    }

    .profile-card-1 {
        position: relative; /* This is needed for the absolute positioning of the status */
    }

    /* Your existing styles remain unchanged */
    .fa-thumbs-up {
        color: #666;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .fa-thumbs-up.liked {
        color: #4267B2;
    }
    
    .fa-thumbs-up:hover {
        color: #4267B2;
    }



  
        .availability-form {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 5px;
        }
        .availability-form label {
            font-size: 0.7rem;
            color: #333;
        }
        .availability-form input[type="radio"] {
            margin-right: 4px;
        }
       
        
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle all like button clicks
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id.startsWith('like-button-')) {
                const profileId = e.target.id.split('-')[2];
                const likeCount = document.getElementById('like-count-' + profileId);
                
                fetch(`/like_profile/${profileId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                    e.target.classList.toggle('liked', data.liked);
                    likeCount.textContent = `${data.total_likes} Like${data.total_likes !== 1 ? 's' : ''}`;
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });
    </script>

{% endblock %}

